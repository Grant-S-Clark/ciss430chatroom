<!-- index.html -->
<html>

  <head>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <title>CISS430 Chatroom</title>
  </head>
  
  {% include 'header.html' %}
  
  <body>
    <div class="sidebar">
      <h3>Your Chatrooms</h3>
      <ul class="chatroom-list" id="chatroomList">
        {% for chatroom in chatrooms %}
            <li class="{% if chatroom.id == chat_id %}active{% endif %}" 
                onclick="switchChatroom('{{ chatroom.id }}')">
                {{ chatroom.label }}
            </li>
         {% endfor %}
        <li class="new" onclick="window.location.href = 'chat_type'">
          New Chat
        </li>
      </ul>
    </div>

    <div class="main-content">
      <h1>{{ chat_label }}</h1>
      <br>
      <div class="chat-container" id="chat-window">
        {% for msg in messages %}
        <div class="message {% if msg.username == username %}user{%else%}other{%endif%}">
          <strong>{{ msg.username }}</strong>: {{ msg.message }}
          <br>
          <small>{{ msg.time_sent }}</small>
        </div>
        {% endfor %}
      </div>

      <form class="message-form" action="index" method="POST">
        <input type="text" name="message" class="message-input" placeholder="Type your message..." required>
        <button type="submit" class="send-button">Send</button>
      </form>

      {% if chat_type == "DM" %}
      <form action="close_dm" method="POST" onsubmit="return confirmCloseDM()">
        <button type="submit" class="close-dm-button">Close DM</button>
      </form>
      {% endif %}

      {% include 'flash_handler.html' %}
    </div>
    
  </body>
</html>

<!-- Scroll function for text box -->
<script>
  function scroll_to_bottom()
  {
      var chat_window = document.getElementById("chat-window");
      chat_window.scrollTop = chat_window.scrollHeight;
  }
  
  scroll_to_bottom();
</script>

<!-- Deletion confirmations -->
<script>
  function confirmCloseDM() {
    return confirm("Are you sure you want to close this DM? This will delete all messages for both users.");
}
</script>

<!-- Scripts for websockets -->
<!-- Get websocket library -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.5.4/socket.io.js"></script>

<!-- handle message receive -->
<script>
  var socket = io();
  var currentUsername ="{{ username|safe }}"; // Get logged-in user's name from Jinja

  // chatroom switching script
  function switchChatroom(chatroomId) {
      window.location.href = `/index?chat_id=${chatroomId}`;
  }
  
  document.querySelector(".message-form").addEventListener("submit", function (e) {
      e.preventDefault();
      var messageInput = document.querySelector(".message-input");
      var message = messageInput.value.trim();
      var chatId = parseInt("{{ chat_id|safe }}")
      if (message) {
          socket.emit("send_message", { message: message });
          messageInput.value = "";
      }
  });

  socket.on("receive_message", function (data) {
      var chatWindow = document.getElementById("chat-window");

      var messageClass = (data.username == currentUsername) ? "user" : "other";
      var newMessage = document.createElement("div");
      newMessage.classList.add("message", messageClass);
      newMessage.innerHTML = `<strong>${data.username}</strong>: ${data.message}<br><small>${data.time_sent}</small>`;
      chatWindow.appendChild(newMessage);
      chatWindow.scrollTop = chatWindow.scrollHeight;
  });
</script>
